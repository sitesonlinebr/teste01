<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin • Magão Tênis</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="container topbar__row">
      <a class="brand" href="./index.html">
        <span class="brand__logo">MT</span>
        <span class="brand__name">ADMIN</span>
      </a>

      <div style="flex:1"></div>

      <a class="iconBtn" href="./index.html">Voltar</a>
      <a class="iconBtn" href="./checkout.html">Checkout</a>
    </div>
  </header>

  <main class="container" style="padding:14px 0 26px">
    <section class="sectionTitleRow">
      <h2>Cadastro de produtos</h2>
      <div class="muted" id="status">—</div>
    </section>

    <section class="card" style="padding:14px">
      <form id="form" style="display:flex;flex-direction:column;gap:12px">
        <input id="id" type="hidden" />
        <input id="imageData" type="hidden" />

        <div class="opts">
          <div class="optBox">
            <b>Nome</b>
            <input id="name" required placeholder="Ex: Tênis Nike Revolution 8" style="border:0;outline:0;background:transparent;font-weight:900">
          </div>
          <div class="optBox">
            <b>Marca</b>
            <input id="brand" required placeholder="Ex: Nike" style="border:0;outline:0;background:transparent;font-weight:900">
          </div>
        </div>

        <div class="opts">
          <div class="optBox">
            <b>Categoria</b>
            <select id="category" required style="border:0;outline:0;background:transparent;font-weight:900">
              <option value="">Selecione…</option>
              <option value="corrida">Corrida</option>
              <option value="casual">Casual</option>
              <option value="basket">Basquete</option>
              <option value="skate">Skate</option>
            </select>
          </div>

          <div class="optBox">
            <b>Ativo para venda?</b>
            <select id="active" required style="border:0;outline:0;background:transparent;font-weight:900">
              <option value="true">Sim</option>
              <option value="false">Não</option>
            </select>
          </div>
        </div>

        <div class="opts">
          <div class="optBox">
            <b>Preço (Pix)</b>
            <input id="price" required inputmode="decimal" placeholder="Ex: 341,99" style="border:0;outline:0;background:transparent;font-weight:900">
          </div>
          <div class="optBox">
            <b>Preço antigo (opcional)</b>
            <input id="oldPrice" inputmode="decimal" placeholder="Ex: 399,99" style="border:0;outline:0;background:transparent;font-weight:900">
          </div>
        </div>

        <div class="opts">
          <div class="optBox">
            <b>Desconto % (opcional)</b>
            <input id="discountPercent" inputmode="numeric" placeholder="Ex: 15" style="border:0;outline:0;background:transparent;font-weight:900">
          </div>
          <div class="optBox">
            <b>Parcelas (opcional)</b>
            <input id="installments" inputmode="numeric" placeholder="Ex: 5" style="border:0;outline:0;background:transparent;font-weight:900">
          </div>
        </div>

        <div class="opts">
          <div class="optBox">
            <b>Tamanhos (separe por vírgula)</b>
            <input id="sizes" required placeholder="37,38,39,40" style="border:0;outline:0;background:transparent;font-weight:900">
          </div>
          <div class="optBox">
            <b>Cores (opcional, vírgula)</b>
            <input id="colors" placeholder="Preto, Branco" style="border:0;outline:0;background:transparent;font-weight:900">
          </div>
        </div>

        <div class="optBox">
          <b>Descrição</b>
          <input id="desc" required placeholder="Ex: Conforto para corridas..." style="border:0;outline:0;background:transparent;font-weight:900">
        </div>

        <div class="optBox">
          <b>Foto do produto (upload)</b>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <input id="file" type="file" accept="image/*">
            <button id="removePhoto" class="btn btn--ghost" type="button">Remover foto</button>
          </div>

          <div style="margin-top:10px;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff">
            <img id="preview" alt="Prévia" style="width:100%;height:220px;object-fit:cover">
          </div>
          <div class="muted" style="margin-top:8px">Dica técnica: use imagem leve (até ~900KB) pra não travar.</div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn--primary" type="submit">Salvar</button>
          <button id="clear" class="btn" type="button">Novo</button>
          <button id="delete" class="btn btn--danger" type="button" style="display:none">Excluir</button>
        </div>
      </form>
    </section>

    <section class="sectionTitleRow">
      <h2>Lista</h2>
      <div class="muted" id="count">0</div>
    </section>

    <section id="list" class="grid"></section>
  </main>

  <script>
    (function(){
      const LS_PRODUCTS = "magao_products";
      const LEGACY_PRODUCTS = ["magao_products_v2","magao_products_v1","magao_products_v1"];

      const $ = (id)=>document.getElementById(id);

      function readJSON(k){ try{return JSON.parse(localStorage.getItem(k)||"null")}catch{return null} }
      function writeJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

      function migrateProducts(){
        if(localStorage.getItem(LS_PRODUCTS)) return;
        for(const k of LEGACY_PRODUCTS){
          const v = readJSON(k);
          if(Array.isArray(v) && v.length){ writeJSON(LS_PRODUCTS, v); break; }
        }
      }

      function moneyToNumberBR(v){
        const raw=(v||"").toString().trim();
        if(!raw) return null;
        const cleaned=raw.replace(/\./g,"").replace(",",".").replace(/[^\d.]/g,"");
        const num=Number(cleaned);
        return Number.isFinite(num)?num:null;
      }
      function genId(){
        return "mt-" + Math.random().toString(16).slice(2,8) + "-" + Date.now().toString(16).slice(-4);
      }
      function parseComma(v){
        return (v||"").split(",").map(s=>s.trim()).filter(Boolean);
      }
      function escapeHtml(str){
        return String(str).replace(/[&<>"']/g,(m)=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]));
      }
      function defaultSvg(name){
        const text=(name||"Produto").split(" ").slice(0,2).join(" ");
        const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600">
          <rect width="100%" height="100%" fill="#ffffff"/>
          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
            font-family="Arial" font-size="44" fill="#111827" opacity="0.7">${escapeHtml(text)}</text>
        </svg>`;
        return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg.trim());
      }

      function loadProducts(){
        const arr=readJSON(LS_PRODUCTS);
        return Array.isArray(arr)?arr:[];
      }
      function saveProducts(list){
        writeJSON(LS_PRODUCTS, list);
      }

      // refs
      const status=$("status"), count=$("count"), listEl=$("list");

      const form=$("form");
      const id=$("id");
      const imageData=$("imageData");
      const name=$("name"), brand=$("brand"), category=$("category"), active=$("active");
      const price=$("price"), oldPrice=$("oldPrice"), discountPercent=$("discountPercent"), installments=$("installments");
      const sizes=$("sizes"), colors=$("colors"), desc=$("desc");
      const file=$("file"), preview=$("preview");
      const removePhoto=$("removePhoto"), clearBtn=$("clear"), deleteBtn=$("delete");

      function setStatus(){
        const products=loadProducts();
        status.textContent = `Salvos: ${products.length}`;
      }

      function clearForm(){
        id.value="";
        imageData.value="";
        name.value="";brand.value="";category.value="";active.value="true";
        price.value="";oldPrice.value="";discountPercent.value="";installments.value="";
        sizes.value="";colors.value="";desc.value="";
        file.value="";
        preview.src=defaultSvg("Sem foto");
        deleteBtn.style.display="none";
      }

      async function readFileAsDataURL(f){
        return new Promise((resolve,reject)=>{
          const fr=new FileReader();
          fr.onload=()=>resolve(String(fr.result));
          fr.onerror=reject;
          fr.readAsDataURL(f);
        });
      }

      file.addEventListener("change", async ()=>{
        const f=file.files && file.files[0];
        if(!f) return;
        const okTypes=["image/jpeg","image/png","image/webp","image/jpg"];
        if(!okTypes.includes(f.type)){ alert("Use JPG/PNG/WEBP."); file.value=""; return; }
        const maxBytes=900*1024;
        if(f.size>maxBytes){ alert("Imagem muito pesada (até ~900KB)."); file.value=""; return; }
        const dataUrl=await readFileAsDataURL(f);
        imageData.value=dataUrl;
        preview.src=dataUrl;
      });

      removePhoto.addEventListener("click", ()=>{
        file.value="";
        imageData.value="";
        preview.src=defaultSvg(name.value || "Sem foto");
      });

      function renderList(){
        const products=loadProducts();
        count.textContent = `${products.length} produto(s)`;

        listEl.innerHTML = products.slice().map(p=>{
          const img = p.image || defaultSvg(p.name);
          return `
            <article class="card">
              <div class="card__img">
                ${p.discountPercent ? `<div class="badgeOff">-${Number(p.discountPercent)||0}%</div>` : ""}
                <img src="${img}" alt="${escapeHtml(p.name)}">
              </div>
              <div class="card__body">
                <div class="card__title">${escapeHtml(p.name)}</div>
                <div class="card__meta">
                  <span class="pill">${escapeHtml(p.brand||"")}</span>
                  <span class="pill">${escapeHtml(p.category||"")}</span>
                  <span class="pill">${p.active ? "Ativo" : "Inativo"}</span>
                </div>
                <div class="muted">${escapeHtml(p.desc||"")}</div>
                <div class="actions">
                  <button class="btn btn--primary" type="button" data-edit="${p.id}">Editar</button>
                </div>
              </div>
            </article>
          `;
        }).join("");

        if(!products.length){
          listEl.innerHTML = `<div class="muted" style="padding:10px">Nenhum produto cadastrado.</div>`;
        }
      }

      listEl.addEventListener("click",(e)=>{
        const btn=e.target.closest("[data-edit]");
        if(!btn) return;
        const pid=btn.getAttribute("data-edit");
        const products=loadProducts();
        const p=products.find(x=>x.id===pid);
        if(!p) return;

        id.value=p.id;
        name.value=p.name||"";
        brand.value=p.brand||"";
        category.value=p.category||"";
        active.value=String(!!p.active);

        price.value=String(p.price ?? "").replace(".",",");
        oldPrice.value=String(p.oldPrice ?? "").replace(".",",");
        discountPercent.value=String(p.discountPercent ?? "");
        installments.value=String(p.installments ?? "");

        sizes.value=Array.isArray(p.sizes)?p.sizes.join(","):"";
        colors.value=Array.isArray(p.colors)?p.colors.join(","):"";
        desc.value=p.desc||"";

        imageData.value=p.image||"";
        preview.src=p.image||defaultSvg(p.name);

        deleteBtn.style.display="";
        window.scrollTo({top:0,behavior:"smooth"});
      });

      deleteBtn.addEventListener("click", ()=>{
        const pid=id.value;
        if(!pid) return;
        if(!confirm("Excluir este produto?")) return;
        let products=loadProducts();
        products=products.filter(p=>p.id!==pid);
        saveProducts(products);
        clearForm();
        renderList();
        setStatus();
        alert("Excluído.");
      });

      clearBtn.addEventListener("click", clearForm);

      form.addEventListener("submit",(e)=>{
        e.preventDefault();

        const pPrice = moneyToNumberBR(price.value);
        if(pPrice===null){ alert("Preço inválido."); return; }

        const pOld = moneyToNumberBR(oldPrice.value);
        const disc = Number((discountPercent.value||"").trim());
        const inst = Number((installments.value||"").trim());

        const sz = parseComma(sizes.value);
        if(!sz.length){ alert("Informe tamanhos (ex: 37,38,39)."); return; }
        const cl = parseComma(colors.value);

        const payload={
          id: id.value || genId(),
          name: name.value.trim(),
          brand: brand.value.trim(),
          category: category.value,
          active: active.value==="true",
          price: pPrice,
          oldPrice: pOld,
          discountPercent: Number.isFinite(disc) ? disc : 0,
          installments: Number.isFinite(inst) && inst>0 ? inst : 5,
          sizes: sz,
          colors: cl,
          desc: desc.value.trim(),
          image: imageData.value.trim(),
          stars: 5
        };

        if(!payload.name || !payload.brand || !payload.category || !payload.desc){
          alert("Preencha nome, marca, categoria e descrição.");
          return;
        }

        let products=loadProducts();
        const idx=products.findIndex(p=>p.id===payload.id);
        if(idx>=0) products[idx]=payload;
        else products.unshift(payload);

        saveProducts(products);

        // ✅ dispara evento pra outras páginas atualizarem
        localStorage.setItem("__magao_ping__", String(Date.now()));

        clearForm();
        renderList();
        setStatus();
        alert("Salvo!");
      });

      // init
      migrateProducts();
      setStatus();
      clearForm();
      renderList();
    })();
  </script>
</body>
</html>
