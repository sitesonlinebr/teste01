<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin • Magão Tênis</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="container topbar__row">
      <a class="brand" href="./index.html" aria-label="Voltar ao site">
        <span class="brand__logo">MT</span>
        <span class="brand__name">Admin</span>
      </a>

      <a class="btn btn--ghost" href="./index.html">← Ver catálogo</a>
    </div>

    <nav class="container chips" aria-label="Ações">
      <button id="btnNovo" class="chip is-active" type="button">Cadastrar produto</button>
      <button id="btnLista" class="chip" type="button">Lista</button>
      <button id="btnExport" class="chip" type="button">Exportar</button>
      <button id="btnImport" class="chip" type="button">Importar</button>
      <button id="btnReset" class="chip" type="button">Restaurar padrão</button>
    </nav>
  </header>

  <main class="container" style="padding:18px 0 26px">
    <section class="hero" style="grid-template-columns: 1.15fr .85fr;">
      <div class="hero__text">
        <h1>Produtos (sem links externos)</h1>
        <p>
          Cadastre, edite e deixe disponível para venda. A foto é enviada pelo botão e fica salva no navegador.
        </p>
        <p class="muted" style="margin:0">
          Dica: use <b>Exportar</b> para guardar backup e <b>Importar</b> para restaurar em outro aparelho.
        </p>
      </div>

      <div class="hero__card">
        <div class="hero__cardTitle">Resumo</div>
        <div class="totals">
          <div class="totals__row">
            <span>Total</span>
            <b id="totalProdutos">0</b>
          </div>
          <div class="totals__row">
            <span>Ativos</span>
            <b id="totalAtivos">0</b>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <a class="btn btn--primary" href="./index.html">Abrir loja</a>
          <a class="btn" href="./checkout.html">Checkout</a>
        </div>
      </div>
    </section>

    <!-- CADASTRO / EDIÇÃO -->
    <section id="secForm" class="hero" style="grid-template-columns: 1fr; padding-top:10px">
      <div class="hero__text">
        <h2 style="margin:0 0 12px 0">Cadastrar / Editar</h2>

        <form id="produtoForm" class="form">
          <input id="editId" type="hidden" />
          <input id="imageData" type="hidden" />

          <div class="form__row">
            <label class="label">
              Nome do produto
              <input id="nome" required placeholder="Ex: Nike Air Max" />
            </label>

            <label class="label">
              Marca
              <input id="marca" required placeholder="Ex: Nike" />
            </label>
          </div>

          <div class="form__row">
            <label class="label">
              Categoria
              <select id="categoria" required>
                <option value="">Selecione…</option>
                <option value="corrida">Corrida</option>
                <option value="casual">Casual</option>
                <option value="basket">Basquete</option>
                <option value="skate">Skate</option>
              </select>
            </label>

            <label class="label">
              Disponível para venda?
              <select id="ativo" required>
                <option value="true">Sim</option>
                <option value="false">Não</option>
              </select>
            </label>
          </div>

          <div class="form__row">
            <label class="label">
              Preço (R$)
              <input id="preco" required inputmode="decimal" placeholder="Ex: 249,90" />
            </label>

            <label class="label">
              Preço antigo (opcional)
              <input id="precoAntigo" inputmode="decimal" placeholder="Ex: 329,90" />
            </label>
          </div>

          <div class="form__row">
            <label class="label">
              Tamanhos (separe por vírgula)
              <input id="tamanhos" required placeholder="Ex: 37,38,39,40,41,42" />
            </label>

            <label class="label">
              Cores (opcional, separe por vírgula)
              <input id="cores" placeholder="Ex: Preto, Branco, Azul" />
            </label>
          </div>

          <div class="form__row">
            <label class="label" style="grid-column:1/-1">
              Descrição
              <input id="desc" required placeholder="Ex: Confortável, leve, solado macio..." />
            </label>
          </div>

          <div class="form__row">
            <div class="label" style="grid-column:1/-1">
              Foto do produto
              <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
                <input id="file" type="file" accept="image/*" />
                <button id="btnRemoverFoto" class="btn btn--ghost" type="button">Remover foto</button>
              </div>
              <div class="muted" style="margin-top:6px">A imagem é salva no navegador (recomendado foto leve).</div>

              <div style="
                margin-top:10px;
                border:1px solid rgba(255,255,255,.08);
                background:rgba(255,255,255,.03);
                border-radius:16px;
                overflow:hidden;
                width:min(520px,100%);
              ">
                <img id="preview" alt="Prévia" style="display:block;width:100%;height:240px;object-fit:cover" />
              </div>
            </div>
          </div>

          <div class="form__row">
            <button class="btn btn--primary" type="submit" id="btnSalvar">Salvar produto</button>
            <button class="btn btn--ghost" type="button" id="btnLimpar">Limpar</button>
            <button class="btn btn--danger" type="button" id="btnExcluir" style="display:none">Excluir</button>
          </div>

          <div class="muted" style="margin-top:10px">
            Importante: por ser salvo localmente, se você limpar dados do navegador, perde os produtos (use exportar).
          </div>
        </form>
      </div>
    </section>

    <!-- LISTA -->
    <section id="secLista" style="display:none">
      <div class="sectionTitleRow">
        <h2>Produtos cadastrados</h2>
        <div class="muted" id="listaInfo"></div>
      </div>

      <div class="search" style="margin-bottom:12px">
        <input id="filtro" type="search" placeholder="Filtrar por nome, marca, categoria..." />
        <button id="limparFiltro" class="btn btn--ghost" type="button">✕</button>
      </div>

      <section id="lista" class="grid" style="grid-template-columns:repeat(3,1fr)"></section>
    </section>

    <!-- MODAL JSON -->
    <div id="jsonModal" class="drawer" aria-hidden="true">
      <div class="drawer__backdrop" data-close></div>
      <div class="drawer__panel" role="dialog" aria-modal="true" aria-label="JSON">
        <div class="drawer__header">
          <div>
            <div class="drawer__title" id="jsonTitle">JSON</div>
            <div class="muted" id="jsonSubtitle">Backup</div>
          </div>
          <button class="btn btn--ghost" type="button" data-close>✕</button>
        </div>

        <div class="drawer__body">
          <textarea id="jsonArea" style="
            width:100%;height:55vh;resize:vertical;
            border:1px solid rgba(255,255,255,.12);
            background:rgba(255,255,255,.06);
            color:var(--text);padding:12px;border-radius:12px;outline:none;
          "></textarea>
        </div>

        <div class="drawer__footer">
          <div class="drawer__actions">
            <button id="btnCopiarJson" class="btn btn--primary" type="button">Copiar</button>
            <button id="btnAplicarJson" class="btn" type="button">Aplicar</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <style>
    .form{display:flex;flex-direction:column;gap:12px}
    .form__row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .label{display:flex;flex-direction:column;gap:8px;font-weight:800}
    .label input, .label select{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 12px;border-radius:12px;
      outline:none;
    }
    .label input::placeholder{color:rgba(233,236,242,.55)}
    @media (max-width: 900px){
      #secLista .grid{grid-template-columns:repeat(2,1fr) !important}
    }
    @media (max-width: 720px){
      .form__row{grid-template-columns:1fr}
      #secLista .grid{grid-template-columns:1fr !important}
    }
  </style>

  <script>
    (function(){
      const LS_PRODUCTS = "magao_products_v2"; // versão nova

      const $ = (id) => document.getElementById(id);

      function normalize(s){
        return (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
      }

      function moneyToNumberBR(v){
        const raw = (v||"").toString().trim();
        if(!raw) return null;
        const cleaned = raw.replace(/\./g,"").replace(",",".").replace(/[^\d.]/g,"");
        const num = Number(cleaned);
        return Number.isFinite(num) ? num : null;
      }

      function genId(){
        return "mt-" + Math.random().toString(16).slice(2, 8) + "-" + Date.now().toString(16).slice(-4);
      }

      function escapeHtml(str){
        return String(str).replace(/[&<>"']/g, (m)=>({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
        }[m]));
      }
      function escapeAttr(str){ return String(str).replace(/"/g,'&quot;'); }

      function capCategory(cat){
        const map = {corrida:"Corrida",casual:"Casual",basket:"Basquete",skate:"Skate"};
        return map[cat]||cat;
      }

      function defaultSvg(name){
        const t = (name||"Produto").split(" ").slice(0,2).join(" ");
        const svg = `
          <svg xmlns="http://www.w3.org/2000/svg" width="800" height="600">
            <defs>
              <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#6ee7ff" stop-opacity="0.35"/>
                <stop offset="1" stop-color="#9b87ff" stop-opacity="0.35"/>
              </linearGradient>
            </defs>
            <rect width="100%" height="100%" fill="url(#g)"/>
            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
              font-family="Arial" font-size="44" fill="#e9ecf2" opacity="0.95">${escapeHtml(t)}</text>
          </svg>`;
        return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg.trim());
      }

      function loadProducts(){
        try{
          const raw = localStorage.getItem(LS_PRODUCTS);
          const arr = raw ? JSON.parse(raw) : null;
          if(Array.isArray(arr) && arr.length) return arr;
        }catch{}
        return [
          {
            id:"mt-001",
            name:"Tênis Corrida AirFlow Pro",
            brand:"Magão",
            category:"corrida",
            price:249.9,
            oldPrice:329.9,
            sizes:["37","38","39","40","41","42","43"],
            colors:["Preto","Branco"],
            desc:"Leve, confortável e com boa absorção de impacto.",
            image:"",
            active:true
          },
          {
            id:"mt-002",
            name:"Tênis Casual Street Lux",
            brand:"Urban",
            category:"casual",
            price:189.9,
            oldPrice:null,
            sizes:["36","37","38","39","40","41","42"],
            colors:["Branco"],
            desc:"Estilo para o dia a dia, combina com tudo.",
            image:"",
            active:true
          }
        ];
      }
      function saveProducts(list){
        localStorage.setItem(LS_PRODUCTS, JSON.stringify(list));
      }

      let products = loadProducts();
      saveProducts(products);

      // refs
      const secForm = $("secForm");
      const secLista = $("secLista");

      const btnNovo = $("btnNovo");
      const btnLista = $("btnLista");
      const btnExport = $("btnExport");
      const btnImport = $("btnImport");
      const btnReset = $("btnReset");

      const totalProdutos = $("totalProdutos");
      const totalAtivos = $("totalAtivos");

      const produtoForm = $("produtoForm");
      const editId = $("editId");

      const nome = $("nome");
      const marca = $("marca");
      const categoria = $("categoria");
      const ativo = $("ativo");
      const preco = $("preco");
      const precoAntigo = $("precoAntigo");
      const tamanhos = $("tamanhos");
      const cores = $("cores");
      const desc = $("desc");

      const file = $("file");
      const imageData = $("imageData");
      const preview = $("preview");
      const btnRemoverFoto = $("btnRemoverFoto");

      const btnLimpar = $("btnLimpar");
      const btnExcluir = $("btnExcluir");

      const lista = $("lista");
      const listaInfo = $("listaInfo");
      const filtro = $("filtro");
      const limparFiltro = $("limparFiltro");

      const jsonModal = $("jsonModal");
      const jsonTitle = $("jsonTitle");
      const jsonSubtitle = $("jsonSubtitle");
      const jsonArea = $("jsonArea");
      const btnCopiarJson = $("btnCopiarJson");
      const btnAplicarJson = $("btnAplicarJson");

      function moneyBRL(v){
        return (Number(v)||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
      }

      function setTab(tab){
        [btnNovo, btnLista].forEach(b => b.classList.remove("is-active"));
        if(tab === "novo") btnNovo.classList.add("is-active");
        if(tab === "lista") btnLista.classList.add("is-active");
        secForm.style.display = tab === "novo" ? "" : "none";
        secLista.style.display = tab === "lista" ? "" : "none";
      }

      btnNovo.addEventListener("click", ()=> setTab("novo"));
      btnLista.addEventListener("click", ()=> { setTab("lista"); renderLista(); });

      function renderResumo(){
        totalProdutos.textContent = String(products.length);
        totalAtivos.textContent = String(products.filter(p=>p.active).length);
      }

      function clearForm(){
        editId.value = "";
        nome.value = "";
        marca.value = "";
        categoria.value = "";
        ativo.value = "true";
        preco.value = "";
        precoAntigo.value = "";
        tamanhos.value = "";
        cores.value = "";
        desc.value = "";
        imageData.value = "";
        file.value = "";
        preview.src = defaultSvg("Sem foto");
        btnExcluir.style.display = "none";
      }

      function fillForm(p){
        editId.value = p.id;
        nome.value = p.name || "";
        marca.value = p.brand || "";
        categoria.value = p.category || "";
        ativo.value = String(!!p.active);
        preco.value = (p.price ?? "").toString().replace(".", ",");
        precoAntigo.value = (p.oldPrice ?? "").toString().replace(".", ",");
        tamanhos.value = (p.sizes || []).join(",");
        cores.value = (p.colors || []).join(",");
        desc.value = p.desc || "";
        imageData.value = p.image || "";
        preview.src = p.image || defaultSvg(p.name);
        btnExcluir.style.display = "";
      }

      btnLimpar.addEventListener("click", clearForm);

      btnExcluir.addEventListener("click", ()=>{
        const id = editId.value;
        if(!id) return;
        if(!confirm("Deseja excluir este produto?")) return;
        products = products.filter(p=>p.id !== id);
        saveProducts(products);
        renderResumo();
        clearForm();
        renderLista();
        alert("Produto excluído.");
      });

      // upload foto
      file.addEventListener("change", async ()=>{
        const f = file.files && file.files[0];
        if(!f) return;

        const okTypes = ["image/jpeg","image/png","image/webp","image/jpg"];
        if(!okTypes.includes(f.type)){
          alert("Use JPG, PNG ou WEBP.");
          file.value = "";
          return;
        }

        // limite simples para não explodir o localStorage
        const maxBytes = 900 * 1024; // ~900KB
        if(f.size > maxBytes){
          alert("Foto muito pesada. Use uma imagem mais leve (até ~900KB).");
          file.value = "";
          return;
        }

        const dataUrl = await readFileAsDataURL(f);
        imageData.value = dataUrl;
        preview.src = dataUrl;
      });

      btnRemoverFoto.addEventListener("click", ()=>{
        file.value = "";
        imageData.value = "";
        preview.src = defaultSvg(nome.value || "Sem foto");
      });

      function readFileAsDataURL(file){
        return new Promise((resolve, reject)=>{
          const fr = new FileReader();
          fr.onload = () => resolve(String(fr.result));
          fr.onerror = reject;
          fr.readAsDataURL(file);
        });
      }

      function parseListComma(v){
        return (v||"")
          .split(",")
          .map(s=>s.trim())
          .filter(Boolean);
      }

      produtoForm.addEventListener("submit", (e)=>{
        e.preventDefault();

        const pPrice = moneyToNumberBR(preco.value);
        if(pPrice === null) { alert("Preço inválido."); return; }

        const pOld = moneyToNumberBR(precoAntigo.value);
        const sizesArr = parseListComma(tamanhos.value);
        if(!sizesArr.length){
          alert("Informe ao menos 1 tamanho (ex: 37,38,39).");
          return;
        }
        const colorsArr = parseListComma(cores.value);

        const payload = {
          id: editId.value || genId(),
          name: nome.value.trim(),
          brand: marca.value.trim(),
          category: categoria.value,
          price: pPrice,
          oldPrice: pOld,
          sizes: sizesArr,
          colors: colorsArr,
          desc: desc.value.trim(),
          image: imageData.value.trim(),
          active: ativo.value === "true"
        };

        if(!payload.name || !payload.brand || !payload.category || !payload.desc){
          alert("Preencha os campos obrigatórios.");
          return;
        }

        const idx = products.findIndex(x=>x.id === payload.id);
        if(idx >= 0) products[idx] = payload;
        else products.unshift(payload);

        saveProducts(products);
        renderResumo();
        renderLista();
        clearForm();
        alert("Produto salvo!");
      });

      // lista
      function renderLista(){
        const q = normalize(filtro.value);
        const list = products
          .slice()
          .sort((a,b)=> (b.active?1:0) - (a.active?1:0))
          .filter(p=>{
            if(!q) return true;
            const hay = normalize(`${p.name} ${p.brand} ${p.category} ${p.desc}`);
            return hay.includes(q);
          });

        listaInfo.textContent = `Mostrando ${list.length} produto(s)`;
        lista.innerHTML = list.map(p=>{
          const imgSrc = p.image || defaultSvg(p.name);
          return `
            <article class="card">
              <div class="card__img">
                <img src="${imgSrc}" alt="${escapeAttr(p.name)}" />
              </div>
              <div class="card__body">
                <div class="card__title">${escapeHtml(p.name)}</div>
                <div class="card__meta">
                  <span class="pill">${escapeHtml(p.brand)}</span>
                  <span class="pill">${escapeHtml(capCategory(p.category))}</span>
                  <span class="pill">${p.active ? "Ativo" : "Inativo"}</span>
                </div>
                <div class="muted">${escapeHtml(p.desc)}</div>
                <div class="priceRow">
                  <div>
                    <div class="price">${moneyBRL(p.price)}</div>
                    <div class="old">${p.oldPrice ? moneyBRL(p.oldPrice) : "—"}</div>
                  </div>
                </div>
                <div class="muted">Tamanhos: ${escapeHtml((p.sizes||[]).join(", "))}</div>
                ${p.colors && p.colors.length ? `<div class="muted">Cores: ${escapeHtml(p.colors.join(", "))}</div>` : ""}

                <div class="card__actions">
                  <button class="btn btn--primary" type="button" data-edit="${p.id}">Editar</button>
                </div>
              </div>
            </article>
          `;
        }).join("");

        if(!list.length){
          lista.innerHTML = `<div class="muted" style="padding:10px">Nenhum produto encontrado.</div>`;
        }
      }

      lista.addEventListener("click", (e)=>{
        const btn = e.target.closest("[data-edit]");
        if(!btn) return;
        const id = btn.getAttribute("data-edit");
        const p = products.find(x=>x.id === id);
        if(!p) return;
        setTab("novo");
        fillForm(p);
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      filtro.addEventListener("input", renderLista);
      limparFiltro.addEventListener("click", ()=>{ filtro.value=""; renderLista(); filtro.focus(); });

      // JSON modal
      function openJsonModal(){
        jsonModal.classList.add("is-open");
        jsonModal.setAttribute("aria-hidden","false");
        document.body.style.overflow="hidden";
      }
      function closeJsonModal(){
        jsonModal.classList.remove("is-open");
        jsonModal.setAttribute("aria-hidden","true");
        document.body.style.overflow="";
      }
      jsonModal.addEventListener("click",(e)=>{
        if(e.target.matches("[data-close]") || e.target.closest("[data-close]")) closeJsonModal();
      });
      document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeJsonModal(); });

      btnExport.addEventListener("click", ()=>{
        jsonTitle.textContent = "Exportar produtos (JSON)";
        jsonSubtitle.textContent = "Copie e guarde";
        jsonArea.value = JSON.stringify(products, null, 2);
        openJsonModal();
      });

      btnImport.addEventListener("click", ()=>{
        jsonTitle.textContent = "Importar produtos (JSON)";
        jsonSubtitle.textContent = "Cole e clique em Aplicar";
        jsonArea.value = "";
        openJsonModal();
      });

      btnCopiarJson.addEventListener("click", async ()=>{
        try{
          await navigator.clipboard.writeText(jsonArea.value);
          alert("Copiado!");
        }catch{
          alert("Não consegui copiar automaticamente. Copie manualmente.");
        }
      });

      btnAplicarJson.addEventListener("click", ()=>{
        try{
          const parsed = JSON.parse(jsonArea.value || "[]");
          if(!Array.isArray(parsed)) throw new Error("Formato inválido");
          for(const p of parsed){
            if(!p.id || !p.name || !p.brand || !p.category || !p.price || !p.sizes) throw new Error("JSON incompleto");
          }
          products = parsed.map(p=>({
            ...p,
            active: !!p.active,
            sizes: Array.isArray(p.sizes) ? p.sizes : [],
            colors: Array.isArray(p.colors) ? p.colors : []
          }));
          saveProducts(products);
          renderResumo();
          renderLista();
          closeJsonModal();
          alert("Importado com sucesso!");
        }catch{
          alert("JSON inválido.");
        }
      });

      btnReset.addEventListener("click", ()=>{
        if(!confirm("Restaurar padrão? Isso substitui sua lista atual.")) return;
        localStorage.removeItem(LS_PRODUCTS);
        products = loadProducts();
        saveProducts(products);
        renderResumo();
        renderLista();
        clearForm();
        alert("Restaurado.");
      });

      // init
      renderResumo();
      clearForm();
      setTab("novo");
    })();
  </script>
</body>
</html>
